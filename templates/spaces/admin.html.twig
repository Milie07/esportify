{% extends 'base.html.twig' %}

{% block title %}Dashboard Admin ‚Äî Esportify
{% endblock %}

{% block body %}
	<div class="container-fluid mx-auto">
		{% for type, flashes in app.flashes() %}
			{% for msg in flashes %}
				<div class="alert alert-{{ type }} text-center">
					{{ msg }}
				</div>
			{% endfor %}
		{% endfor %}
		{% block img %}
			<img class="avatar avatar_player d-block mx-auto" src="{{ asset(avatarUrl) }}" alt="avatar">
		{% endblock %}
		<!-- Titre de la page -->
		<h1 class="text-center text-beige">Bienvenue
			<span>{{ app.user.pseudo }}
				<br>
				{{ app.user.memberScore}}
				üèÜ</span>
		</h1>

		<!-- Section rapports √©v√®nements -->
		<section class="container-lg my-3 my-lg-3 py-2 py-lg-3">
			<div
				class="row text_description text-center gap-2 gap-lg-0 mx-auto">

				<!-- Scores  -->
				<div class="col-12 col-lg-4">
					<div class="card bg-clair2 rounded-2 text-lightBlue p-3">
						<h2 class="card-title">Mes Scores üèÜ</h2>
						{# Favoris A venir #}
					</div>
				</div>

				<!-- Favoris -->
				<div class="col-12 col-lg-4">
					<div class="card bg-clair2 rounded-2 text-lightBlue p-3">
						<h2 class="card-title">Mes Favoris ‚≠ê</h2>
						{# Favoris A venir #}
					</div>
				</div>

				<!-- Historique -->
				<div class="col-12 col-lg-4">
					<div class="card bg-clair2 rounded-2 gap-2 text-lightBlue p-3">
						<h2>Mon Historique üìú</h2>
						{# Historique A venir #}
					</div>
				</div>

			</div>
		</section>

		<!-- Messagerie page Contact-->
		<section class="container-lg bg-clair2 my-3 my-lg-3 py-2 py-lg-3">
			<div class="text_description text-center text-lightBlue gap-2 gap-lg-0 mx-auto">
				<h2>Messages re√ßus</h2>
				<table class="table">
					<thead>
						<tr>
							<th>Pseudo</th>
							<th>Role</th>
							<th>Email</th>
							<th>Sujets</th>
							<th>Message</th>
							<th>Date</th>
							<th rowscope>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for m in messages %}
							<tr>
								<td>{{ m['pseudo'] }}</td>
								<td>{{ m['role'] }}</td>
								<td>{{ m['email'] }}</td>
								<td>{{ m['subject'] }}</td>
								<td>{{ m['message'] }}</td>
								<td>
									{% if m['createdAt'] %}
										{{ m['createdAt']|date('d/m/Y H:i') }}
									{% else %}
										‚Äî
									{% endif %}
								</td>
								<td></td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</section>

		<section class="container-lg bg-clair2 my-3 my-lg-3 py-2 py-lg-3">
			<div class="text_description text-center text-lightBlue gap-2 gap-lg-0 mx-auto">
				<h2>Demandes d'√©v√®nements</h2>

				<h3 class="text-lightBlue mt-4 mb-3 border">Demandes en attente</h3>

				{% if requestsPending is not empty %}
					<table class="table table-bordered table-striped align-middle">
						<thead class="table-light">
							<tr>
								<th>Image</th>
								<th>Tournoi</th>
								<th>Organisateur</th>
								<th>Date cr√©ation</th>
								<th>Actions</th>
							</tr>
						</thead>

						<tbody>
							{% for t in requestsPending %}
								<tr>
									<td style="width: 150px;">
										{% if t.imageUrl %}
											<img src="{{ asset(t.imageUrl) }}" class="img-fluid rounded" style="max-height: 120px; object-fit: cover;">
										{% else %}
											<span class="text-muted small">Aucune image</span>
										{% endif %}
									</td>

									<td>
										<strong>{{ t.title }}</strong><br>
										ID :
										{{ t.tournamentId }}
									</td>

									<td>
										{{ t.pseudo }}<br>
										<small>{{ t.organizerEmail }}</small>
									</td>

									<td>
										{% if t['createdAt'] %}
											{{ t['createdAt']|date('d/m/Y H:i') }}
										{% else %}
											‚Äî
										{% endif %}
									</td>

									<td class="d-flex justify-content-center align-center gap-2">

										<a href="{{ path('admin_tournament_show', { id: t['tournamentId'] }) }}" class="btn btn-info btn-sm">
											Voir
										</a>

										<form action="{{ path('admin_tournament_validate', { id: t['tournamentId'] }) }}" method="POST">
											<button class="btn btn-success btn-sm">Valider</button>
										</form>

										<form action="{{ path('admin_tournament_refuse', { id: t['tournamentId'] }) }}" method="POST">
											<button class="btn btn-danger btn-sm">Refuser</button>
										</form>

									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<p class="text-lightBlue">Aucune demande en attente.</p>
				{% endif %}

				<h3 class="text-success mt-5 mb-3 border">Demandes valid√©es</h3>

				{% if requestsValidated is not empty %}
					<table class="table table-bordered table-striped align-middle">
						<thead class="table-success">
							<tr>
								<th>Image</th>
								<th>Tournoi</th>
								<th>Organisateur</th>
								<th>Date cr√©ation</th>
								<th>Actions</th>
							</tr>
						</thead>

						<tbody>
							{% for t in requestsValidated %}
								<tr>
									<td style="width: 150px;">
										{% if t.imageUrl %}
											<img src="{{ asset(t.imageUrl) }}" class="img-fluid rounded" style="max-height: 120px; object-fit: cover;">
										{% else %}
											<span class="text-muted small">Aucune image</span>
										{% endif %}
									</td>
									<td>
										<strong>{{ t.title }}</strong><br>
										ID :
										{{ t.tournamentId }}
									</td>
									<td>
										{{ t.pseudo }}<br>
										<small>{{ t.organizerEmail }}</small>
									</td>
									<td>
										{% if t['createdAt'] %}
											{{ t['createdAt']|date('d/m/Y H:i') }}
										{% else %}
											‚Äî
										{% endif %}
									</td>
									<td>
										<a href="{{ path('admin_tournament_show', { id: t['tournamentId'] }) }}" class="btn btn-info btn-sm">Voir</a>
										<button class="btn btn-success btn-sm" disabled>Valid√©</button>
										<button class="btn btn-danger btn-sm" disabled>Refus√©</button>
									</td>

								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<p class="text-success">Aucune demande valid√©e.</p>
				{% endif %}

				<h3 class="text-danger mt-5 mb-3 border">Demandes refus√©es</h3>

				{% if requestsRefused is not empty %}
					<table class="table table-bordered table-striped align-middle">
						<thead class="table-danger">
							<tr>
								<th>Image</th>
								<th>Tournoi</th>
								<th>Organisateur</th>
								<th>Date cr√©ation</th>
								<th>Actions</th>
							</tr>
						</thead>

						<tbody>
							{% for t in requestsRefused %}
								<tr>
									<td style="width: 150px;">
										{% if t.imageUrl %}
											<img src="{{ asset(t.imageUrl) }}" class="img-fluid rounded" style="max-height: 120px; object-fit: cover;">
										{% else %}
											<span class="text-muted small">Aucune image</span>
										{% endif %}
									</td>

									<td>
										<strong>{{ t.title }}</strong><br>
										ID :
										{{ t.tournamentId }}
									</td>

									<td>
										{{ t.pseudo }}<br>
										<small>{{ t.organizerEmail }}</small>
									</td>

									<td>
										{% if t['createdAt'] %}
											{{ t['createdAt']|date('d/m/Y H:i') }}
										{% else %}
											‚Äî
										{% endif %}
									</td>

									<td>
										<a href="{{ path('admin_tournament_show', { id: t['tournamentId'] }) }}" class="btn btn-info btn-sm">Voir</a>
										<button class="btn btn-success btn-sm" disabled>Valid√©</button>
										<button class="btn btn-danger btn-sm" disabled>Refus√©</button>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<p class="text-danger">Aucune demande refus√©e.</p>
				{% endif %}
			</div>
		</section>

		{# <!-- Section gestion √©v√®nements --> #}
		<section class="container-lg  my-3 my-lg-3 py-2 py-lg-3">
			<div class="bg-clair2 rounded-2 justify-content-center p-3 mx-auto">
				<h2 class="text-center text-lightBlue mb-3">Mes Ev√®nements</h2>
				<div class="row g-4">
					{% for tournament in tournaments %}
						<div class="col-12 col-md-6 col-lg-4">
							<div class="card align-items-center mx-auto shadow-lg">
								<div class="ratio ratio-4x3 overflow-hidden">
									<img class="card-img-top object-fit-cover" src="{{ asset(tournament.getImagePath()) }}" alt="Image de {{ tournament.title }}">
								</div>
								<div class="card-body">
									<h3 class="card-title text-center text-lightBlue">{{ tournament.title }}</h3>
									<p class="text-description text-center text-darkBlue p-0 m-0">D√©marre le
										<span>{{ tournament.startAt|date('d/m/Y H:i', 'Europe/Paris') }}</span>
									</p>
									<p class="text-description text-center text-darkBlue p-0 mb-3">Se termine le
										<span>{{ tournament.endAt|date('d/m/Y H:i', 'Europe/Paris') }}</span>
									</p>

									{# BADGE DE STATUT #}
									<span class="badge rounded-pill d-block mx-auto w-50 p-2 mb-3
										{% if tournament.currentStatus.value == 'En Attente' %} bg-warning text-dark
										{% elseif tournament.currentStatus.value == 'Valid√©' %} bg-success
										{% elseif tournament.currentStatus.value == 'En Cours' %} bg-primary
										{% elseif tournament.currentStatus.value == 'Termin√©' %} bg-secondary
										{% elseif tournament.currentStatus.value == 'Refus√©' %} bg-danger
										{% endif %}">
										{{ tournament.currentStatus.value }}
									</span>

									<div class="d-flex justify-content-between ">
										<a class="btn btn-beige rounded-pill text-lightBlue" href="#">
											<span class="d-inline-block" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-trigger="hover" data-bs-content="Liste des Inscrits">
												<i class="fa-solid fa-people-group fa-2xl"></i>
											</span>
										</a>
										<a class="btn btn-beige rounded-pill text-lightBlue" href="#">
											<span class="d-inline-block" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-trigger="hover" data-bs-content="Modifier l'event">
												<i class="fa-solid fa-file-pen fa-xl"></i>
											</span>
										</a>
										{# Bouton d√©marrer : affich√© seulement si tournoi valid√© et dans les 30 min avant #}
										{% set now = "now"|date("U") %}
										{% set start = tournament.startAt|date("U") %}
										{% set diff = start - now %}
										{% if tournament.currentStatus.value == 'Valid√©' and diff <= 1800 and diff >= 0 %}
											<a class="btn btn-greenFluo rounded-pill text-lightBlue" href="#">
												<span class="d-inline-block" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-trigger="hover" data-bs-content="D√©marrer l'event">
													<i class="fa-solid fa-play fa-xl"></i>
												</span>
											</a>
										{% endif %}
									</div>

								</div>
							</div>
						</div>
					{% else %}
						<p class="text-center text-lightBlue">Aucun √©v√®nement cr√©√© pour le moment.</p>
					{% endfor %}
				</div>
				<h2 class="text-center mt-4">Cr√©er mon √©venement üéâ</h2>

				<!-- Formulaire de Cr√©ation d'event -->
				<form action="{{ path('event_create') }}" method="POST" class="form_contact bg-beige rounded-2 border border-lightBlue text_description text-lightBlue px-5 pt-4 pb-2" id="searchForm" enctype="multipart/form-data">
					<input
					type="hidden" name="_csrf_token" value="{{ csrf_token('event_create') }}">
					<!-- Informations -->
					<div class="mx-auto">
						<label class="" for="title">Titre de l'√©v√®nement :</label>
						<input class="form-control input_filter mb-3" id="title" name="title" type="text" minlength="2" maxlength="120" required></div>
					<div class="mx-auto">
						<label class="" for="description">Description :</label>
						<textarea class="form-control input_filter mb-3" name="description" type="text" id="description"></textarea>
					</div>
					<div class="mx-auto">
						<label class="" for="tagline">Tagline :
						</label>
						<input class="form-control input_filter mb-3" name="tagline" type="text" id="tagline" minlength="15" maxlength="60"></input>
				</div>
				<div class="mx-auto">
					<label class="" for="startAt">Date et Heure de D√©but :</label><input id="startAt" name="startAt" type="datetime-local" class="form-control input_filter mb-3" required></div>
				<div class="mx-auto">
					<label class="" for="endAt">Date et Heure de Fin :</label><input class="form-control input_filter mb-3" id="endAt" name="endAt" type="datetime-local" required></div>
				<div class="mx-auto">
					<label class="" for="capacityGauge">Nombre maximal de joueurs :</label><input class="form-control input_filter mb-3" id="capacityGauge" name="capacityGauge" type="number" min="10" max="100" required></div>
				<div class="mx-auto">
					<label class="" for="tournamentImage">Image ou photo de l'√©v√®nement :</label><input class="form-control input_filter mb-3" id="tournamentImage" name="tournamentImage" type="file" accept="image/png, image/jpeg" required></div>
				<div class="d-flex justify-content-center">
					<button class="btn-custom-sm-green btn btn-greenFluo" type="submit">Cr√©er</button>
				</div>

			</form>
		</div>
	</section>

	<!-- Section gestion infos perso -->
	<section class="container-lg my-3 my-lg-3 py-2 py-lg-3">
		<div class="bg-clair2 rounded-2 text-lightBlue text-center mx-auto p-3">
			<h2>Mes informations personnelles ‚úèÔ∏è</h2>

			<!-- Formulaire d'Inscription -->
			<form
				action="#" method="POST" class="form_contact bg-beige rounded-2 border border-lightBlue text_description text-lightBlue px-5 pt-4 pb-2">

				<!-- Informations personnelles -->
				<div class="w-75 mx-auto">
					<label class="" for="name">Nom :
					</label>
					<input class="form-control input_filter mb-3" id="name" name="name" type="text" minlength="2" maxlength="50" value="{{ app.user.lastName }}" disabled autocomplete required>
				</div>
				<div class="w-75 mx-auto">
					<label class="" for="surname">Pr√©nom :
					</label>
					<input class="form-control input_filter mb-3" id="surname" name="surname" type="text" minlength="2" maxlength="50" value="{{ app.user.firstName }}" disabled required>
				</div>
				<div class="w-75 mx-auto">
					<label class="" for="pseudo">Pseudo :
					</label>
					<input class="form-control input_filter mb-3" id="pseudo" name="pseudo" type="text" minlength="2" maxlength="50" value="{{ app.user.pseudo }}" disabled required>
				</div>
				<div class="w-75 mx-auto">
					<label class="" for="mail">Email :
					</label>
					<input class="form-control input_filter mb-3" id="mail" name="mail" type="email" value="{{ app.user.email }}" disabled required>
				</div>
				<div class="w-75 mx-auto">
					<label class="" for="password">Mot de Passe :
					</label>
					<input class="form-control input_filter mb-3" id="password" name="password" type="password" placeholder="*********" disabled required>
				</div>

				<div class="text-center">
					<a class="btn-custom-md-green btn btn-greenFluo align-self-center my-2" href="{{ path('modifProfile') }}">Modifier ‚öôÔ∏è</a>
				</div>
			</form>
		</div>
	</section>

	<div class="text-center mt-4">
		<a class="btn-custom-lg-clair btn btn-clair2 mb-4" href="{{ path('app_home') }}">Retour √† l'accueil</a>
	</div>
</section></div>{% if tournament is defined %}
<div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.6)">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">

			<div class="modal-header">
				<h5 class="modal-title">{{ tournament.title }}</h5>
				<a href="{{ path('admin_dashboard') }}" class="btn-close"></a>
			</div>

			<div class="modal-body">
				<img src="{{ asset(tournament.getImagePath()) }}" class="img-fluid mb-3"/>

				<p>
					<strong>Description :</strong>
					{{ tournament.description }}</p>
				<p>
					<strong>Slogan :</strong>
					{{ tournament.tagline }}</p>
				<p>
					<strong>D√©but :</strong>
					{{ tournament.startAt|date('d/m/Y H:i') }}</p>
				<p>
					<strong>Fin :</strong>
					{{ tournament.endAt|date('d/m/Y H:i') }}</p>
				<p>
					<strong>Places :</strong>
					{{ tournament.capacityGauge }}</p>
				<p>
					<strong>Statut :</strong>
					{{ tournament.currentStatus.value }}</p>
			</div>

		</div>
	</div>
</div>{% endif %}{% endblock %}
